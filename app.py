import streamlit as st
import pandas as pd
import openpyxl

# ğŸ”¹ 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
file_path = "ê²½ì°°í…ŒìŠ¤íŠ¸_ê²°ê³¼.xlsx"

try:
    data = pd.read_excel(file_path)
except FileNotFoundError:
    st.error(f"âŒ '{file_path}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì˜ˆì¸¡ ëª¨ë¸ì„ ì‹¤í–‰í•˜ì„¸ìš”.")
    st.stop()

# ğŸ”¹ 2. ì»¬ëŸ¼ëª… ì •ë¦¬
data.columns = data.columns.str.strip()  # ê³µë°± ì œê±°

# ğŸ”¹ 3. ì§€ì—­ ì»¬ëŸ¼ ë³µì› (get_dummies ë³€í™˜ëœ í˜•ì‹ ì²˜ë¦¬)
ì§€ì—­ì»¬ëŸ¼ë“¤ = [col for col in data.columns if col.startswith("ì§€ì—­_")]

if ì§€ì—­ì»¬ëŸ¼ë“¤:
    # ğŸ”¹ "ì§€ì—­_" ì ‘ë‘ì‚¬ë¥¼ ì œê±°í•˜ê³ , ê°’ì´ 1ì¸ ì»¬ëŸ¼ì˜ ì´ë¦„ì„ ê°€ì ¸ì˜´
    data["ì§€ì—­"] = data[ì§€ì—­ì»¬ëŸ¼ë“¤].idxmax(axis=1).str.replace("ì§€ì—­_", "")

    # ğŸ”¹ ë¶ˆí•„ìš”í•œ ì›-í•« ì¸ì½”ë”© ì»¬ëŸ¼ ì‚­ì œ
    data.drop(columns=ì§€ì—­ì»¬ëŸ¼ë“¤, inplace=True)

# ğŸ”¹ 4. "ì§€ì—­" ì»¬ëŸ¼ í™•ì¸
if "ì§€ì—­" not in data.columns:
    st.error("âŒ 'ì§€ì—­' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.")
    st.stop()

# ğŸ”¹ 5. UI êµ¬ì„±
st.subheader("ğŸš” ê²½ì°° ê³µì±„ í•„ê¸°ì‹œí—˜ í•©ê²© ì ìˆ˜ ì˜ˆì¸¡")
st.write("ì§€ì—­ì„ ì„ íƒí•˜ë©´ ì˜ˆìƒ í•©ê²© ì ìˆ˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!")

# ğŸ”¹ 6. ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ì§€ì—­ ì„ íƒ
ì§€ì—­ëª©ë¡ = sorted(data["ì§€ì—­"].unique())  # ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
ì„ íƒì§€ì—­ = st.selectbox("ğŸ“ ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”", ì§€ì—­ëª©ë¡)

# ğŸ”¹ 7. ì„ íƒí•œ ì§€ì—­ì˜ ì˜ˆì¸¡ ì ìˆ˜ í‘œì‹œ
ì˜ˆì¸¡ì ìˆ˜ = data.loc[data["ì§€ì—­"] == ì„ íƒì§€ì—­, "í•©ê²©ì˜ˆì¸¡ì ìˆ˜"].values

if len(ì˜ˆì¸¡ì ìˆ˜) > 0:
    st.subheader(f"ğŸ“Œ {ì„ íƒì§€ì—­} ì˜ˆìƒ í•©ê²© ì ìˆ˜: **{ì˜ˆì¸¡ì ìˆ˜[0]:.2f}** ì ")
else:
    st.error("í•´ë‹¹ ì§€ì—­ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

# ğŸ”¹ 8. ë°ì´í„° ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
st.download_button(
    label="ğŸ“¥ ì˜ˆì¸¡ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ",
    data=data.to_csv(index=False).encode("utf-8"),
    file_name="ê²½ì°°í…ŒìŠ¤íŠ¸_ê²°ê³¼.csv",
    mime="text/csv"
)
